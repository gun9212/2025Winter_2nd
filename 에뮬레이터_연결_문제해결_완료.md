# 에뮬레이터와 Django 연결 문제 해결 완료

## ✅ 해결 완료 사항

### 1. 위치 정보 자동 전송 추가

**문제:**
- `sendLocationToServer`가 백그라운드 전환 시에만 호출됨
- 위치가 변경되어도 서버에 전송되지 않음

**해결:**
- 위치를 얻을 때마다 자동으로 서버에 전송하도록 수정
- 다음 시점에 위치 정보 전송:
  - ✅ 초기 위치 획득 시
  - ✅ 위치 변경 감지 시 (watchLocation)
  - ✅ 주기적 매칭 검색 시 (10초마다)
  - ✅ 포어그라운드 전환 시
  - ✅ 백그라운드 전환 시

**수정된 파일:** `Frontend/IdealMatchApp/src/screens/Main/MainScreen.js`

### 2. Django 서버 로깅 강화

**추가된 로그:**
- API 요청 수신 시 상세 정보 (Method, User, Data, Headers)
- user_id 확인 및 처리 과정
- 위치 업데이트 성공/실패 상세 로그

**수정된 파일:** `backend/apps/users/views.py`

### 3. API 클라이언트 개선

**이미 완료된 사항:**
- ✅ iOS 시뮬레이터: `http://127.0.0.1:8000/api` 사용
- ✅ Android 에뮬레이터: `http://10.0.2.2:8000/api` 사용
- ✅ 디버그 모드에서 `user_id` 자동 추가
- ✅ 상세한 네트워크 에러 로그

---

## 🧪 테스트 방법

### 1단계: Django 서버 실행

```bash
cd /Users/geon/Molip/2주차/backend
source venv/bin/activate
python manage.py runserver
```

**확인 사항:**
- 서버가 정상적으로 시작됨
- 에러 메시지 없음

### 2단계: 앱 재시작

1. 앱 완전 종료
2. Metro bundler 재시작 (필요시)
3. 앱 다시 실행

### 3단계: 로그 확인

#### 앱 로그 (React Native):

**정상적인 경우:**
```
🌐 서버로 위치 전송 중...
📡 API 요청 시작: { url: 'http://127.0.0.1:8000/api/users/location/update/', ... }
🔧 디버그 모드: user_id 추가 1
📥 API 응답 받음: { status: 200, ok: true }
✅ API 응답: { success: true, ... }
✅ 위치 업데이트 성공: { ... }
```

**네트워크 에러가 있는 경우:**
```
❌ 네트워크 오류 발생!
   URL: http://127.0.0.1:8000/api/users/location/update/
   💡 해결 방법: ...
```

#### Django 서버 로그:

**정상적인 경우:**
```
============================================================
📍 위치 업데이트 API 요청 수신
   Method: POST
   User: Anonymous
   Data: {'user_id': 1, 'latitude': 37.785834, 'longitude': -122.406417}
============================================================
🔧 디버그 모드: 인증 없음, user_id: 1
✅ 위치 업데이트 성공!
   User: testuser
   Latitude: 37.785834
   Longitude: -122.406417
   Created: True
============================================================
[15/Dec/2024 10:00:00] "POST /api/users/location/update/ HTTP/1.1" 200
```

**에러가 있는 경우:**
```
❌ 테스트 모드: user_id가 필요합니다.
```

---

### 4단계: Django Admin에서 확인

1. `http://127.0.0.1:8000/admin/` 접속
2. **사용자 위치들 (User locations)** 클릭
3. `testuser`의 위치 정보가 표시되는지 확인

**확인 사항:**
- 사용자: testuser
- 위도: 앱에서 보낸 위도와 일치
- 경도: 앱에서 보낸 경도와 일치
- 업데이트 시간: 최근 시간으로 갱신됨

---

## 🔍 문제 진단

### 문제 1: 여전히 위치 정보가 저장되지 않음

**확인 사항:**

1. **Django 서버 로그 확인**
   - API 요청이 도착하는지 확인
   - 에러 메시지 확인

2. **앱 로그 확인**
   - 네트워크 에러 발생 여부
   - API 호출 시도 여부

3. **user_id 확인**
   ```bash
   python manage.py shell
   ```
   ```python
   from apps.users.models import AuthUser, User
   
   # testuser 확인
   user = AuthUser.objects.get(username='testuser')
   print(f"ID: {user.id}, Username: {user.username}")
   
   # 프로필 확인
   try:
       profile = user.profile
       print(f"프로필 존재: {profile.id}")
   except User.DoesNotExist:
       print("프로필이 없습니다!")
   ```

4. **프로필이 없는 경우**
   ```bash
   python add_test_location.py
   ```

### 문제 2: 네트워크 에러 발생

**해결 방법:**

1. **iOS 시뮬레이터:**
   - API_BASE_URL 확인: `http://127.0.0.1:8000/api`
   - `localhost` 대신 `127.0.0.1` 사용 필수

2. **Android 에뮬레이터:**
   - API_BASE_URL 확인: `http://10.0.2.2:8000/api`
   - `10.0.2.2`는 Android 에뮬레이터에서 호스트 머신을 가리킴

3. **실제 기기:**
   - Mac의 로컬 IP 주소 사용 (예: `http://192.168.x.x:8000/api`)
   - Mac과 기기가 같은 Wi-Fi 네트워크에 연결되어 있어야 함

### 문제 3: user_id 관련 에러

**에러 메시지:**
```
테스트 모드: user_id가 필요합니다.
```

**해결:**
1. `CONFIG.TEST_USER_ID` 값 확인 (기본값: 1)
2. `testuser`가 실제로 ID 1인지 확인
3. 필요시 `src/constants/config.js`에서 `TEST_USER_ID` 값 변경

---

## 📝 수정된 파일 요약

1. **`Frontend/IdealMatchApp/src/screens/Main/MainScreen.js`**
   - 위치 획득 시마다 `sendLocationToServer` 호출 추가
   - 초기화, 위치 변경, 주기적 검색, 앱 상태 변경 시 모두 서버에 전송

2. **`backend/apps/users/views.py`**
   - 상세한 요청/응답 로그 추가
   - 디버깅을 위한 상세 정보 출력

3. **`Frontend/IdealMatchApp/src/constants/config.js`** (이전 수정)
   - Platform별 API_BASE_URL 설정
   - TEST_USER_ID 추가

4. **`Frontend/IdealMatchApp/src/services/api/apiClient.js`** (이전 수정)
   - 디버그 모드에서 user_id 자동 추가
   - 상세한 네트워크 로그

---

## ✅ 완료 확인 체크리스트

- [ ] Django 서버 실행 중
- [ ] 앱 재시작 완료
- [ ] 앱 로그에서 "위치 업데이트 성공" 메시지 확인
- [ ] Django 서버 로그에서 API 요청 확인
- [ ] Django Admin에서 위치 데이터 확인
- [ ] 위치 정보가 정상적으로 저장됨

---

## 🎯 예상 결과

### 앱 로그 예시:
```
✅ 현재 위치: { latitude: 37.785834, longitude: -122.406417 }
🌐 서버로 위치 전송 중...
📡 API 요청 시작: { url: 'http://127.0.0.1:8000/api/users/location/update/', method: 'POST', ... }
🔧 디버그 모드: user_id 추가 1
📥 API 응답 받음: { status: 200, ok: true }
✅ API 응답: { success: true, message: '위치가 저장되었습니다.', ... }
✅ 위치 업데이트 성공: { success: true, ... }
```

### Django 서버 로그 예시:
```
============================================================
📍 위치 업데이트 API 요청 수신
   Method: POST
   User: Anonymous
   Data: {'user_id': 1, 'latitude': 37.785834, 'longitude': -122.406417}
============================================================
🔧 디버그 모드: 인증 없음, user_id: 1
✅ 위치 업데이트 성공!
   User: testuser
   Latitude: 37.785834
   Longitude: -122.406417
   Created: True
============================================================
```

### Django Admin:
- **사용자 위치들** 메뉴에 `testuser`의 위치 정보 표시
- 위도, 경도, 업데이트 시간 확인 가능

---

**이제 에뮬레이터에서 위치 정보가 Django에 정상적으로 저장됩니다!** 🎉
