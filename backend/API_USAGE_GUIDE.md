# API 사용 가이드 - 기능과 필요 시점

## 📱 실제 앱 사용 시나리오별 API 사용

---

## 🔐 1단계: 회원가입 및 로그인

### API 1: 회원가입 (`POST /api/auth/register/`)

**기능:**
- 새로운 사용자 계정을 생성합니다
- `username`, `password`, `phone_number`를 데이터베이스에 저장
- 비밀번호는 자동으로 암호화되어 저장됨

**필요한 때:**
- ✅ 앱을 처음 설치하고 회원가입 화면에서 "가입하기" 버튼을 누를 때
- ✅ 사용자가 ID, 비밀번호, 전화번호를 입력하고 제출할 때

**예시 시나리오:**
```
사용자: "회원가입 화면에서 정보 입력 → 가입하기 버튼 클릭"
앱: API 1 호출 → 성공 시 "인증번호를 발송했습니다" 메시지 표시
```

---

### API 2: 전화번호 인증 (`POST /api/auth/verify-phone/`)

**기능:**
- 전화번호 인증번호를 검증합니다
- 인증 성공 시 `phone_verified = true`로 변경

**필요한 때:**
- ✅ 회원가입 후 인증번호 입력 화면에서 인증번호를 입력하고 "인증하기" 버튼을 누를 때
- ✅ 전화번호 인증이 완료되어야 서비스를 이용할 수 있도록 설정한 경우

**예시 시나리오:**
```
사용자: "인증번호 123456 입력 → 인증하기 버튼 클릭"
앱: API 2 호출 → 성공 시 "인증 완료" 메시지 표시 → 로그인 화면으로 이동
```

---

### API 3: 로그인 (`POST /api/auth/login/`)

**기능:**
- 사용자 인증 후 JWT 토큰을 발급합니다
- 이후 모든 API 호출에 이 토큰을 사용하여 인증

**필요한 때:**
- ✅ 로그인 화면에서 ID와 비밀번호를 입력하고 "로그인" 버튼을 누를 때
- ✅ 앱을 재실행했을 때 저장된 토큰이 없거나 만료된 경우

**예시 시나리오:**
```
사용자: "ID: user123, 비밀번호 입력 → 로그인 버튼 클릭"
앱: API 3 호출 → 토큰 저장 → 메인 화면으로 이동
```

---

### API 4: 토큰 갱신 (`POST /api/auth/refresh/`)

**기능:**
- 만료된 Access Token을 Refresh Token으로 새로 발급받습니다
- 사용자가 다시 로그인할 필요 없이 서비스를 계속 이용할 수 있게 함

**JWT 토큰의 두 가지 종류:**
1. **Access Token**: API 호출 시 인증에 사용 (짧은 수명)
   - 만료되면 API 호출이 401 에러로 실패
   - 보안을 위해 자주 갱신됨
2. **Refresh Token**: Access Token을 갱신하는 데 사용 (긴 수명)
   - Access Token이 만료되면 이 토큰으로 새 Access Token 발급
   - 만료되면 다시 로그인해야 함

**현재 프로젝트 설정:**
- **Access Token**: **30분** (보안과 편의성의 균형)
- **Refresh Token**: **3일** (사용자 편의를 위해 설정)

**필요한 때:**
- ✅ 앱을 사용 중에 Access Token이 만료되어 API 호출이 실패할 때 (자동 호출)
- ✅ API 호출 전에 토큰 만료 시간을 확인하여 사전에 갱신할 때
- ✅ 앱 시작 시 저장된 토큰이 만료되었는지 확인하고 갱신할 때

**예시 시나리오:**
```
시나리오 1: 자동 갱신
앱: "프로필 조회 API 호출 → 401 에러 (토큰 만료)"
앱: "자동으로 API 4 호출 → 새 Access Token 발급"
앱: "새 토큰으로 프로필 조회 API 재호출 → 성공"

시나리오 2: 사전 갱신
앱: "API 호출 전 토큰 만료 시간 확인 → 1분 후 만료 예정"
앱: "API 4 호출하여 미리 토큰 갱신"
앱: "새 토큰으로 API 호출 → 성공"

시나리오 3: Refresh Token 만료
앱: "API 4 호출 → 401 에러 (Refresh Token도 만료)"
앱: "로그인 화면으로 이동 → 사용자가 다시 로그인 필요"

구현 시
시나리오 2 (우선) -> 시나리오 1 (대비) -> 시나리오 3
```

---

## 👤 2단계: 프로필 설정

### API 5: 프로필 조회 (`GET /api/users/profile/`)

**기능:**
- 현재 로그인한 사용자의 프로필 정보를 가져옵니다
- 나이, 성별, 키, MBTI, 성격, 관심사 등 모든 프로필 정보 반환

**필요한 때:**
- ✅ 프로필 화면을 열었을 때 기존 정보를 표시하기 위해
- ✅ 프로필 수정 화면에서 기존 값을 불러와서 입력 필드에 채우기 위해
- ✅ 앱 시작 시 프로필이 완성되었는지 확인하기 위해

**예시 시나리오:**
```
사용자: "프로필 탭 클릭"
앱: API 5 호출 → 받은 데이터로 화면 구성 → "나이: 25, 성별: 남성, 키: 175cm..." 표시
```

---

### API 6: 프로필 생성/수정 (`POST/PUT /api/users/profile/`)

**기능:**
- 사용자 프로필을 처음 생성하거나 수정합니다
- 나이, 성별, 키, MBTI, 성격 리스트, 관심사 리스트를 저장
- 성격과 관심사는 최소 1개 이상 필수

**필요한 때:**
- ✅ 회원가입 후 처음 프로필을 입력할 때 (POST)
- ✅ 프로필 수정 화면에서 정보를 변경하고 "저장" 버튼을 누를 때 (PUT)
- ✅ 프로필 입력 화면에서 모든 필드를 입력하고 "완료" 버튼을 누를 때

**예시 시나리오:**
```
사용자: "프로필 입력 화면에서 나이: 25, 성별: 남성, 키: 175, MBTI: ENFP 선택, 
        성격: [활발한, 긍정적인] 선택, 관심사: [영화, 음악, 여행] 선택 → 저장 버튼 클릭"
앱: API 6 호출 → 성공 시 "프로필이 저장되었습니다" 메시지 표시
```

---

### API 7: 프로필 완성도 확인 (`GET /api/users/profile/completeness/`)

**기능:**
- 프로필과 이상형 프로필이 모두 완성되었는지 확인합니다
- 서비스를 시작할 수 있는지 판단하는 데 사용

**필요한 때:**
- ✅ 메인 화면 진입 시 서비스 시작 가능 여부를 확인하기 위해
- ✅ 서비스 활성화 버튼을 누르기 전에 완성도 체크하기 위해
- ✅ 프로필/이상형 프로필 수정 후 완성도 재확인하기 위해

**예시 시나리오:**
```
사용자: "메인 화면 진입"
앱: API 7 호출 → "프로필 완성도: 100%, 이상형 프로필 완성도: 100%" 표시
     → "서비스 시작 가능" 버튼 활성화
```

---

## 💕 3단계: 이상형 프로필 설정

### API 8: 이상형 프로필 조회 (`GET /api/users/ideal-type/`)

**기능:**
- 현재 사용자가 설정한 이상형 프로필 정보를 가져옵니다
- 키 범위, 나이 범위, 선호 MBTI, 선호 성격, 선호 관심사 등 반환

**필요한 때:**
- ✅ 이상형 프로필 화면을 열었을 때 기존 설정을 표시하기 위해
- ✅ 이상형 프로필 수정 화면에서 기존 값을 불러와서 입력 필드에 채우기 위해

**예시 시나리오:**
```
사용자: "이상형 프로필 탭 클릭"
앱: API 8 호출 → "키: 160~180cm, 나이: 20~30세, 선호 MBTI: [ENFP, ENTP]..." 표시
```

---

### API 9: 이상형 프로필 생성/수정 (`POST/PUT /api/users/ideal-type/`)

**기능:**
- 이상형 프로필을 처음 생성하거나 수정합니다
- 매칭 알고리즘이 이 정보를 사용하여 적합한 상대를 찾음
- 모든 조건(키, 나이, MBTI, 성격, 관심사)은 최소 1개 이상 필수

**필요한 때:**
- ✅ 이상형 프로필을 처음 입력할 때 (POST)
- ✅ 이상형 프로필 수정 화면에서 조건을 변경하고 "저장" 버튼을 누를 때 (PUT)
- ✅ 이상형 프로필 입력 화면에서 모든 조건을 입력하고 "완료" 버튼을 누를 때

**예시 시나리오:**
```
사용자: "이상형 프로필 입력 화면에서 키: 160~180cm, 나이: 20~30세 선택,
        선호 MBTI: [ENFP, ENTP] 선택, 선호 성격: [활발한, 유머러스한] 선택,
        선호 관심사: [영화, 음악] 선택 → 저장 버튼 클릭"
앱: API 9 호출 → 성공 시 "이상형 프로필이 저장되었습니다" 메시지 표시
```

---

## 📍 4단계: 위치 추적

### API 10: 위치 업데이트 (`POST /api/users/location/`)

**기능:**
- 사용자의 현재 위치(위도, 경도)를 서버에 저장합니다
- 매칭 알고리즘이 거리 계산에 이 정보를 사용

**필요한 때:**
- ✅ 앱이 포그라운드에서 실행 중일 때 30초마다 자동으로 호출
- ✅ 사용자가 위치 추적을 시작했을 때
- ✅ 위치가 크게 변경되었을 때 (예: 100m 이상 이동)

**예시 시나리오:**
```
앱: "위치 추적 시작 → 30초마다 현재 위치 가져오기 → API 10 호출"
서버: "위치 정보 저장 → 매칭 알고리즘 실행 → 가까운 사용자 찾기"
```

---

### API 11: 현재 위치 조회 (`GET /api/users/location/`)

**기능:**
- 서버에 저장된 사용자의 최신 위치 정보를 가져옵니다

**필요한 때:**
- ✅ 지도 화면에서 자신의 위치를 표시하기 위해
- ✅ 위치 정보가 필요한 다른 기능에서 사용하기 위해

**예시 시나리오:**
```
사용자: "지도 화면 열기"
앱: API 11 호출 → 받은 위치 정보로 지도에 마커 표시
```

---

## 🎯 5단계: 매칭 시스템

### API 12: 매칭 가능 인원 수 조회 (`GET /api/matches/matchable-count/`)

**기능:**
- boundary(반경) 내에서 이상형 조건에 부합하는 사용자 수를 조회합니다
- 현재 위치 기준으로 지정된 반경 내에 있는 사람들 중 조건에 부합하는 인원 수를 반환 (예: "현재 50m 반경 내에 3명이 조건에 맞습니다")

**Query Parameters (필수):**
- `latitude` (float): 현재 위치의 위도 (예: 37.5665)
- `longitude` (float): 현재 위치의 경도 (예: 126.9780)
- `radius` (float): 반경 (km 단위, 예: 0.05 = 50m, 기본값: 0.05)

**필요한 때:**
- ✅ 메인 화면에서 "현재 boundary 내 매칭 가능한 인원 수"를 실시간으로 표시하기 위해
- ✅ 사용자에게 서비스 이용 가능 여부를 알려주기 위해
- ✅ 화면에 표시되는 boundary 안에 있는 조건에 부합하는 인원 수를 카운트하여 표시하기 위해

**예시 시나리오:**
```
사용자: "메인 화면 진입"
앱: API 12 호출 (latitude, longitude, radius 포함) 
    → "현재 50m 반경 내에 3명이 이상형 조건에 부합합니다" 메시지 표시
```

---

### API 13: 매칭 체크 (포그라운드) (`GET /api/matches/check/`)

**기능:**
- 앱이 포그라운드에서 실행 중일 때 새로운 매칭이 발생했는지 확인합니다
- 경량 응답으로 빠르게 확인 가능 (폴링에 최적화)
- **주의**: 포그라운드에서는 알림을 표시하지 않습니다 (화면이 켜져있으므로)
- **백그라운드 알림**: 앱이 꺼져있거나 백그라운드에 있을 때는 서버가 자동으로 푸시 알림을 보냅니다

**필요한 때:**
- ✅ 앱이 포그라운드에서 실행 중일 때 10초마다 자동으로 호출
- ✅ 새로운 매칭이 발생했는지 실시간으로 확인하기 위해 (알림 표시 없이)

**예시 시나리오:**
```
앱: "10초마다 API 13 호출 → 새 매칭 발견 시 내부적으로만 처리 (알림 표시 안 함)"
사용자: "앱 사용 중 → 매칭 발생해도 화면에 표시하지 않음"
```

---

## ⚙️ 6단계: 서비스 설정

### API 14: 매칭 동의 업데이트 (`POST /api/users/consent/`) ( ON/OFF 기능 )

**기능:**
- 사용자가 매칭에 동의했는지 여부를 설정합니다
- `matching_consent = true`인 사용자만 매칭 대상에 포함됨

**필요한 때:**
- ✅ 사용자가 "매칭 동의" 토글을 켜거나 끌 때
- ✅ 특정 시간대나 장소에서만 매칭을 원할 때

**예시 시나리오:**
```
사용자: "설정 화면에서 '매칭 동의' 토글 ON"
앱: API 14 호출 → "매칭 동의가 활성화되었습니다" 메시지 표시
서버: "이제 이 사용자를 매칭 대상에 포함시킴"
```

---

## 🔔 7단계: 백그라운드 알림 시스템

### API 15: 백그라운드 알림 등록 (`POST /api/notifications/register/`)

**기능:**
- 앱이 백그라운드에 있거나 화면이 꺼져있을 때 매칭 알림을 받기 위해 푸시 알림 토큰을 등록합니다
- 서버가 매칭을 감지하면 자동으로 푸시 알림을 보냅니다
- **중요**: 화면이 켜져있을 때는 알림이 표시되지 않습니다 (포그라운드에서는 API 14로만 체크)

**필요한 때:**
- ✅ 앱 설치 후 처음 실행 시
- ✅ 로그인 성공 후
- ✅ 푸시 알림 토큰이 갱신되었을 때

**Request Body:**
```json
{
  "fcm_token": "fcm_token_string",  // Firebase Cloud Messaging 토큰
  "device_type": "ios"  // 또는 "android"
}
```

**예시 시나리오:**
```
사용자: "앱 설치 후 로그인"
앱: API 15 호출 → 푸시 알림 토큰 등록
서버: "매칭 발생 시 이 토큰으로 푸시 알림 전송 준비 완료"

사용자: "앱을 백그라운드로 전환 또는 화면 끄기"
서버: "매칭 감지 → 푸시 알림 전송"
사용자: "알림 수신 → '이상형이 근처에 있습니다!' 알림 표시"
```

---

## 🔄 전체 사용자 여정 (User Journey)

### 시나리오: 처음부터 끝까지

```
1. 앱 설치 및 초기 설정
   ↓
2. 회원가입 화면
   → API 1: 회원가입
   → API 2: 전화번호 인증
   ↓
3. 로그인 화면
   → API 3: 로그인 (Access Token 30분 + Refresh Token 3일 발급)
   → API 15: 백그라운드 알림 등록 (푸시 토큰 등록)
   ↓
4. 프로필 입력 화면
   → API 6: 프로필 생성 (나이, 성별, 키, MBTI, 성격, 관심사)
   → API 7: 프로필 완성도 확인
   ↓
5. 이상형 프로필 입력 화면
   → API 9: 이상형 프로필 생성 (키 범위, 나이 범위, 선호 MBTI, 성격, 관심사)
   → API 7: 프로필 완성도 확인 (재확인)
   ↓
6. 메인 화면 진입
   → API 7: 완성도 확인 (서비스 시작 가능 여부 체크)
   → API 12: 매칭 가능 인원 수 조회 (현재 위치 + boundary 반경 내 인원 수)
   → API 14: 매칭 동의 설정 (ON/OFF)
   ↓
7. 위치 추적 시작 (서비스 활성화)
   → API 10: 위치 업데이트 (30초마다 반복)
   → API 13: 매칭 체크 (10초마다 반복, 포그라운드에서만, 알림 표시 안 함)
   ↓
8. 포그라운드 사용 중
   → API 10: 위치 업데이트 (30초마다 계속)
   → API 13: 매칭 체크 (10초마다 계속, 알림 표시 안 함)
   → API 12: 매칭 가능 인원 수 조회 (화면 갱신 시)
   → API 4: 토큰 갱신 (Access Token 만료 시 자동 호출)
   ↓
9. 백그라운드/화면 꺼짐 상태
   → 서버: 매칭 감지 시 자동으로 푸시 알림 전송 (API 15로 등록된 토큰 사용)
   → 사용자: "이상형이 근처에 있습니다!" 알림 수신
   ↓
10. 앱 재실행 또는 토큰 만료
    → API 4: 토큰 갱신 (Refresh Token 사용, 3일 이내)
    → Refresh Token 만료 시: API 3: 로그인 (재로그인 필요)
```

### 주요 흐름 설명

**초기 설정 (1-5단계):**
- 회원가입 → 로그인 → 프로필 입력 → 이상형 프로필 입력
- 모든 정보 입력 완료 후 서비스 시작 가능

**서비스 활성화 (6-7단계):**
- 메인 화면에서 완성도 확인 및 매칭 동의 설정
- 위치 추적 시작 및 매칭 체크 시작

**실제 사용 (8-9단계):**
- 포그라운드: 위치 업데이트 및 매칭 체크 (알림 표시 안 함)
- 백그라운드: 서버가 자동으로 푸시 알림 전송

**토큰 관리 (전 단계):**
- Access Token 만료 시 API 4로 자동 갱신
- Refresh Token 만료 시 재로그인 필요

---

## 📊 API 호출 빈도 요약

| API | 호출 빈도 | 설명 |
|-----|----------|------|
| API | 호출 빈도 | 설명 |
|-----|----------|------|
| API 10 (위치 업데이트) | 30초마다 | 앱 포그라운드 실행 중 |
| API 13 (매칭 체크) | 10초마다 | 앱 포그라운드 실행 중 (알림 표시 안 함) |
| API 15 (백그라운드 알림 등록) | 1회 | 로그인 시 또는 푸시 토큰 갱신 시 |
| API 4 (토큰 갱신) | 필요 시 | Access Token 만료 시 (30분마다) |
| API 1-3, 6, 9, 14 | 사용자 액션 시 | 버튼 클릭, 토글 변경 등 |
| API 5, 8, 11, 12 | 화면 진입 시 | 탭 클릭, 화면 전환 등 |
| API 7 | 상태 확인 시 | 프로필/이상형 프로필 수정 후, 메인 화면 진입 시 |
| 백그라운드 푸시 알림 | 서버 자동 | 앱이 백그라운드/꺼져있을 때 매칭 발생 시 |

---

## ⚠️ 주의사항

1. **API 10 (위치 업데이트)**: 배터리 소모를 고려하여 30초 주기로 호출
2. **API 13 (매칭 체크)**: 포그라운드에서만 사용, 알림 표시하지 않음 (10초 주기)
3. **API 15 (백그라운드 알림 등록)**: 로그인 시 반드시 호출하여 푸시 알림 토큰 등록 필요
4. **백그라운드 알림**: 앱이 꺼져있거나 백그라운드에 있을 때만 푸시 알림이 전송됨
5. **API 4 (토큰 갱신)**: Access Token 만료 시(30분) 자동으로 처리되도록 구현 권장
6. **API 7 (완성도 확인)**: 서비스 시작 전 반드시 확인 필요
7. **API 12 (매칭 가능 인원 수)**: 위치 정보(latitude, longitude, radius) 필수
8. **API 14 (매칭 동의)**: 사용자가 명시적으로 동의해야 매칭 대상에 포함됨

