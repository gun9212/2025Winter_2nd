# 백그라운드 위치 업데이트 진단 결과

## 현재 상황

### ✅ 정상 동작
- **`rlawldus`**: 백그라운드에서도 정기적으로 위치 업데이트 (약 5초마다)
  - `01:41:25` ~ `01:43:05`까지 지속적으로 업데이트됨

### ❌ 문제 발생
- **`gun9212`**: `01:41:38` 이후 위치 업데이트 중단
  - 마지막 업데이트: `01:41:38`
  - 이후 약 1분 30초 동안 업데이트 없음

## 가능한 원인

### 1. iOS 백그라운드 실행 제한
iOS는 배터리 절약을 위해 백그라운드 앱의 실행을 제한합니다:
- 앱이 백그라운드로 전환된 후 일정 시간(약 30초~1분) 후 JavaScript 실행이 중단될 수 있음
- `setInterval`이 백그라운드에서 실행되지 않을 수 있음
- `watchLocation`이 위치가 변경되지 않으면 콜백이 호출되지 않을 수 있음

### 2. 위치 권한 설정
- **"앱 사용 중에만 허용"**: 백그라운드에서 위치 업데이트가 제한됨
- **"항상 허용"**: 백그라운드에서도 위치 업데이트 가능 (필수!)

### 3. 실제 위치 변경 필요
- iOS는 위치가 실제로 변경되지 않으면 업데이트를 보내지 않을 수 있음
- 정지 상태에서는 위치 업데이트가 없을 수 있음

## 해결 방법

### 1. 위치 권한 확인 (가장 중요!)

**`gun9212` 사용자 기기에서 확인:**

1. iOS 설정 앱 열기
2. **개인 정보 보호** > **위치 서비스** > **IdealMatchApp**
3. **"항상"** 선택 확인
   - "앱 사용 중에만 허용"이면 백그라운드 업데이트 불가능!

### 2. 실제 이동 테스트

백그라운드 위치 업데이트는 실제로 이동할 때 더 잘 동작합니다:
- 정지 상태: 위치 업데이트 없을 수 있음
- 이동 중: 위치 업데이트 정상 동작

### 3. 앱 상태 확인

**`gun9212` 사용자 기기에서:**
- 앱이 완전히 종료되었는지 확인
- 백그라운드로 전환되었는지 확인
- 상단 바에 파란색 위치 표시기가 나타나는지 확인

### 4. 네이티브 로그 확인

Xcode 콘솔에서 다음 로그가 나타나는지 확인:
```
✅ 백그라운드 위치 업데이트 활성화: allowsBackgroundLocationUpdates = YES
✅ 자동 일시정지 방지: pausesLocationUpdatesAutomatically = NO
✅ 백그라운드 위치 표시기 활성화: showsBackgroundLocationIndicator = YES
```

## 현재 구현 상태

### ✅ 완료된 작업
1. **네이티브 코드 수정**: `RNCGeolocation.mm`에 백그라운드 설정 추가
   - `allowsBackgroundLocationUpdates = YES`
   - `pausesLocationUpdatesAutomatically = NO`
   - `showsBackgroundLocationIndicator = YES`

2. **Info.plist 설정**: `UIBackgroundModes`에 `location` 포함

3. **JavaScript 설정**: `Geolocation.setConfiguration`으로 `authorizationLevel: 'always'` 설정

### ⚠️ iOS 제한사항
- iOS는 백그라운드에서 JavaScript 실행을 제한할 수 있음
- 위치가 변경되지 않으면 업데이트가 없을 수 있음
- 완벽한 백그라운드 위치 추적은 네이티브 라이브러리(`react-native-background-geolocation`) 필요

## 권장 사항

### 즉시 확인
1. **위치 권한이 "항상 허용"인지 확인** (가장 중요!)
2. 실제로 이동하면서 테스트
3. Xcode 콘솔에서 네이티브 로그 확인

### 장기적 해결책
더 안정적인 백그라운드 위치 추적을 원하면:
- `react-native-background-geolocation` 라이브러리 사용 고려
- 네이티브 모듈로 백그라운드 위치 업데이트 보장

## 테스트 방법

1. **두 사용자 모두 위치 권한 "항상 허용" 설정**
2. **앱 실행 후 백그라운드로 전환**
3. **실제로 이동** (위치 변경)
4. **백엔드 로그에서 위치 업데이트 확인**

## 예상 결과

위치 권한이 "항상 허용"이고 실제로 이동하면:
- 백그라운드에서도 위치 업데이트가 계속됨
- 상단 바에 파란색 위치 표시기 표시
- 백엔드 로그에 정기적인 위치 업데이트 기록
